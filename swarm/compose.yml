services:
  nginx-proxy:
    image: nginx:1.27.0-alpine
    ports:
      - mode: host
        protocol: tcp
        published: 80
        target: 80
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/html:/var/www/html:ro
      - ./nginx/wait-for-dns.sh:/wait-for-dns.sh:ro
    entrypoint: ["sh", "/wait-for-dns.sh"]
    networks:
      - microservices-network
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager]
      resources:
        limits:
          cpus: '0.25'
          memory: 256MB
        reservations:
          cpus: '0.25'
          memory: 256MB
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  iam-service:
    image: registry.gitlab.com/healthcare5314327/microservices/iam-service:latest
    environment:
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: never
      SPRING_PROFILES_ACTIVE: dev
      SPRING_RABBITMQ_SSL_ENABLED: "true"
      SPRING_RABBITMQ_SSL_ALGORITHM: "TLSv1.2"
      SPRING_RABBITMQ_SSL_VALIDATE_SERVER_CERTIFICATE: "true"
      SPRING_RABBITMQ_SSL_VERIFY_HOSTNAME: "true"
      LOGGING_LEVEL_ROOT: WARN
    secrets:
      - db_password
      - iam_db_url
      - db_username
      - smtp_host
      - smtp_port
      - smtp_username
      - smtp_password
      - mongodb_uri
      - rabbitmq_host
      - rabbitmq_port
      - rabbitmq_username
      - rabbitmq_password
      - rabbitmq_vhost
    entrypoint:
      - sh
      - -c
      - >
        export SPRING_DATASOURCE_PASSWORD=$$(cat /run/secrets/db_password) &&
        export SPRING_DATASOURCE_URL=$$(cat /run/secrets/iam_db_url) &&
        export SPRING_DATASOURCE_USERNAME=$$(cat /run/secrets/db_username) &&
        export SPRING_DATA_MONGODB_URI=$$(cat /run/secrets/mongodb_uri) &&
        export SPRING_RABBITMQ_HOST=$$(cat /run/secrets/rabbitmq_host) &&
        export SPRING_RABBITMQ_PORT=$$(cat /run/secrets/rabbitmq_port) &&
        export SPRING_RABBITMQ_USERNAME=$$(cat /run/secrets/rabbitmq_username) &&
        export SPRING_RABBITMQ_PASSWORD=$$(cat /run/secrets/rabbitmq_password) &&
        export SPRING_RABBITMQ_VIRTUAL_HOST=$$(cat /run/secrets/rabbitmq_vhost) &&
        export SPRING_MAIL_HOST=$$(cat /run/secrets/smtp_host) &&
        export SPRING_MAIL_PORT=$$(cat /run/secrets/smtp_port) &&
        export SPRING_MAIL_USERNAME=$$(cat /run/secrets/smtp_username) &&
        export SPRING_MAIL_PASSWORD=$$(cat /run/secrets/smtp_password) &&
        exec java -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom -jar app.jar
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 120s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: pause
        monitor: 120s
        order: stop-first
      placement:
        preferences:
          - spread: node.hostname
      resources:
        limits:
          cpus: '0.5'
          memory: 1GB
        reservations:
          cpus: '0.5'
          memory: 1GB
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/iam/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  patient-service:
    image: registry.gitlab.com/healthcare5314327/microservices/patient-service:latest
    environment:
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: never
      SPRING_PROFILES_ACTIVE: production
      LOGGING_LEVEL_ROOT: WARN
      SPRING_RABBITMQ_SSL_ENABLED: "true"
      SPRING_RABBITMQ_SSL_ALGORITHM: "TLSv1.2"
      SPRING_RABBITMQ_SSL_VALIDATE_SERVER_CERTIFICATE: "true"
      SPRING_RABBITMQ_SSL_VERIFY_HOSTNAME: "true"
    secrets:
      - db_password
      - patient_db_url
      - db_username
      - mongodb_uri
      - rabbitmq_host
      - rabbitmq_port
      - rabbitmq_username
      - rabbitmq_password
      - rabbitmq_vhost
      - jwt_secret
    entrypoint:
      - sh
      - -c
      - >
        export SPRING_DATASOURCE_PASSWORD=$$(cat /run/secrets/db_password) &&
        export SPRING_DATASOURCE_URL=$$(cat /run/secrets/patient_db_url) &&
        export SPRING_DATASOURCE_USERNAME=$$(cat /run/secrets/db_username) &&
        export SPRING_DATA_MONGODB_URI=$$(cat /run/secrets/mongodb_uri) &&
        export SPRING_RABBITMQ_HOST=$$(cat /run/secrets/rabbitmq_host) &&
        export SPRING_RABBITMQ_PORT=$$(cat /run/secrets/rabbitmq_port) &&
        export SPRING_RABBITMQ_USERNAME=$$(cat /run/secrets/rabbitmq_username) &&
        export SPRING_RABBITMQ_PASSWORD=$$(cat /run/secrets/rabbitmq_password) &&
        export SPRING_RABBITMQ_VIRTUAL_HOST=$$(cat /run/secrets/rabbitmq_vhost) &&
        export JWT_SECRET=$$(cat /run/secrets/jwt_secret) &&
        exec java -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom -jar app.jar
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 120s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: pause
        monitor: 120s
        order: stop-first
      placement:
        preferences:
          - spread: node.hostname
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 1GB
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/patient/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  testorder-service:
    image: registry.gitlab.com/healthcare5314327/microservices/testorder-service:latest
    environment:
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: never
      SPRING_PROFILES_ACTIVE: production
      LOGGING_LEVEL_ROOT: WARN
      SPRING_RABBITMQ_SSL_ENABLED: "true"
      SPRING_RABBITMQ_SSL_ALGORITHM: "TLSv1.2"
      SPRING_RABBITMQ_SSL_VALIDATE_SERVER_CERTIFICATE: "true"
      SPRING_RABBITMQ_SSL_VERIFY_HOSTNAME: "true"
    secrets:
      - db_password
      - testorder_db_url
      - db_username
      - mongodb_uri
      - rabbitmq_host
      - rabbitmq_port
      - rabbitmq_username
      - rabbitmq_password
      - rabbitmq_vhost
      - jwt_secret
    entrypoint:
      - sh
      - -c
      - >
        export SPRING_DATASOURCE_PASSWORD=$$(cat /run/secrets/db_password) &&
        export SPRING_DATASOURCE_URL=$$(cat /run/secrets/testorder_db_url) &&
        export SPRING_DATASOURCE_USERNAME=$$(cat /run/secrets/db_username) &&
        export SPRING_DATA_MONGODB_URI=$$(cat /run/secrets/mongodb_uri) &&
        export SPRING_RABBITMQ_HOST=$$(cat /run/secrets/rabbitmq_host) &&
        export SPRING_RABBITMQ_PORT=$$(cat /run/secrets/rabbitmq_port) &&
        export SPRING_RABBITMQ_USERNAME=$$(cat /run/secrets/rabbitmq_username) &&
        export SPRING_RABBITMQ_PASSWORD=$$(cat /run/secrets/rabbitmq_password) &&
        export SPRING_RABBITMQ_VIRTUAL_HOST=$$(cat /run/secrets/rabbitmq_vhost) &&
        export JWT_SECRET=$$(cat /run/secrets/jwt_secret) &&
        exec java -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom -jar app.jar
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 120s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: pause
        monitor: 120s
        order: stop-first
      placement:
        preferences:
          - spread: node.hostname
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 1GB
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/testorder/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

networks:
  microservices-network:
    driver: overlay
    attachable: true

secrets:
  db_password:
    external: true
  iam_db_url:
    external: true
  patient_db_url:
    external: true
  testorder_db_url:
    external: true
  db_username:
    external: true
  smtp_host:
    external: true
  smtp_port:
    external: true
  smtp_username:
    external: true
  smtp_password:
    external: true
  mongodb_uri:
    external: true
  rabbitmq_host:
    external: true
  rabbitmq_port:
    external: true
  rabbitmq_username:
    external: true
  rabbitmq_password:
    external: true
  rabbitmq_vhost:
    external: true
  jwt_secret:
    external: true
